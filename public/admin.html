<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Connect2Roots Admin Dashboard</title>
  <script src="https://unpkg.com/lucide@latest"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #f5f0e8; }
    .container { min-height: 100vh; padding: 24px; max-width: 1200px; margin: 0 auto; }

    /* Login (Mentor-Mentee-main login style) */
    .login-wrap { min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 20px; background: #2b2a2a; }
    .login-card { background: white; border-radius: 24px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); width: 100%; max-width: 450px; padding: 48px; position: relative; overflow: hidden; }
    .login-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 4px; background: linear-gradient(90deg, #2d5016 0%, #4a7c2a 100%); }
    .login-logo { text-align: center; margin-bottom: 32px; }
    .login-logo-icon { width: 64px; height: 64px; background: linear-gradient(135deg, #2d5016 0%, #4a7c2a 100%); border-radius: 16px; display: flex; align-items: center; justify-content: center; margin: 0 auto 16px; color: white; font-size: 24px; font-weight: 700; }
    .login-logo h1 { font-size: 28px; font-weight: 700; color: #1e293b; margin-bottom: 8px; }
    .login-logo p { font-size: 14px; color: #64748b; }
    .login-form .form-group { margin-bottom: 24px; }
    .login-form .form-label { display: block; font-size: 14px; font-weight: 600; color: #1e293b; margin-bottom: 8px; }
    .login-form .form-input { width: 100%; padding: 14px 16px; border: 2px solid #e2e8f0; border-radius: 12px; font-size: 15px; color: #1e293b; background: #f8fafc; outline: none; }
    .login-form .form-input:focus { border-color: #4a7c2a; background: white; }
    .login-form .error { color: #dc2626; font-size: 14px; margin-bottom: 16px; display: none; }
    .login-form .error.show { display: block; }
    .btn-login { width: 100%; padding: 14px; background: linear-gradient(135deg, #2d5016 0%, #4a7c2a 100%); color: white; border: none; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer; }
    .btn-login:hover { box-shadow: 0 8px 20px rgba(74, 124, 42, 0.4); }

    /* Dashboard header (Mentor-Mentee-main dashboard style) */
    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 32px; flex-wrap: wrap; gap: 16px; background: white; padding: 24px; border-radius: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .header-left { display: flex; align-items: center; gap: 16px; }
    .header-logo { width: 48px; height: 48px; border-radius: 12px; background: linear-gradient(135deg, #2d5016 0%, #4a7c2a 100%); display: flex; align-items: center; justify-content: center; color: white; font-size: 18px; font-weight: 700; }
    .title { font-size: 32px; font-weight: 700; color: #1e293b; margin: 0 0 4px 0; }
    .subtitle { font-size: 16px; color: #64748b; margin: 0; }
    .adminInfo { display: flex; align-items: center; gap: 12px; }
    .adminAvatar { width: 48px; height: 48px; border-radius: 12px; background: linear-gradient(135deg, #2d5016 0%, #4a7c2a 100%); display: flex; align-items: center; justify-content: center; color: white; font-size: 16px; font-weight: 700; }
    .adminLabel { font-size: 12px; color: #64748b; margin: 0 0 2px 0; text-transform: uppercase; font-weight: 600; letter-spacing: 0.5px; }
    .adminName { font-size: 15px; font-weight: 600; color: #1e293b; margin: 0; }
    .logoutBtn { padding: 8px 16px; background: #ef4444; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; }
    .logoutBtn:hover { background: #dc2626; }

    /* Stats grid */
    .statsGrid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; margin-bottom: 24px; }
    .statCard { background: white; border-radius: 16px; padding: 24px; display: flex; align-items: center; gap: 16px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    .statIcon { width: 56px; height: 56px; border-radius: 12px; display: flex; align-items: center; justify-content: center; color: white; }
    .statIcon.blue { background: linear-gradient(135deg, #4a7c2a 0%, #2d5016 100%); }
    .statIcon.green { background: linear-gradient(135deg, #6b9c4a 0%, #4a7c2a 100%); }
    .statIcon.yellow { background: linear-gradient(135deg, #d4a574 0%, #8b6f47 100%); }
    .statLabel { font-size: 14px; color: #64748b; margin: 0 0 4px 0; }
    .statValue { font-size: 28px; font-weight: 700; color: #1e293b; margin: 0; }

    /* Tabs (Mentor-Mentee-main tab style) */
    .tabsWrap { margin-bottom: 24px; background: white; border-radius: 16px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); overflow: hidden; }
    .tabs { display: flex; border-bottom: 2px solid #e5e7eb; background: #f9fafb; }
    .tabs button { flex: 1; padding: 16px 24px; background: none; border: none; font-size: 15px; font-weight: 600; color: #6b7280; cursor: pointer; transition: all 0.3s; border-bottom: 3px solid transparent; display: flex; align-items: center; justify-content: center; gap: 8px; }
    .tabs button:hover { background: #f3f4f6; }
    .tabs button.active { background: linear-gradient(135deg, #2d5016 0%, #4a7c2a 100%); color: white; border-bottom-color: #2d5016; }
    .tabContent { padding: 24px; background: white; }
    .tabContent h3 { margin: 0 0 20px 0; font-size: 20px; font-weight: 600; color: #1e293b; }

    /* Resource Videos */
    .videosToolbar { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 16px; margin-bottom: 20px; }
    .videosGrid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
    .videoCard { background: #f8fafc; border-radius: 12px; overflow: hidden; border: 1px solid #e2e8f0; }
    .videoCardThumb { aspect-ratio: 16/9; background: #e2e8f0; position: relative; }
    .videoCardThumb img { width: 100%; height: 100%; object-fit: cover; }
    .videoCardBody { padding: 16px; }
    .videoCardTitle { font-size: 15px; font-weight: 600; color: #1e293b; margin: 0 0 4px 0; line-height: 1.3; }
    .videoCardMeta { font-size: 12px; color: #64748b; margin: 0 0 8px 0; }
    .videoCardDesc { font-size: 13px; color: #475569; margin: 0 0 12px 0; line-height: 1.4; max-height: 2.8em; overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; }
    .videoCardActions { display: flex; gap: 8px; }
    .videoCardActions button { padding: 6px 12px; font-size: 13px; border-radius: 8px; border: 1px solid #e2e8f0; background: white; cursor: pointer; font-weight: 500; color: #475569; }
    .videoCardActions button:hover { background: #f1f5f9; color: #1e293b; }
    .videoCardActions button.delete:hover { background: #fef2f2; color: #dc2626; border-color: #fecaca; }
    .btnAddVideo { padding: 10px 20px; background: linear-gradient(135deg, #2d5016 0%, #4a7c2a 100%); color: white; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; gap: 8px; }
    .btnAddVideo:hover { box-shadow: 0 4px 12px rgba(74, 124, 42, 0.35); }
    .videoModal .form-group { margin-bottom: 16px; }
    .videoModal .form-label { display: block; font-size: 13px; font-weight: 600; color: #374151; margin-bottom: 6px; }
    .videoModal .form-input { width: 100%; padding: 10px 12px; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 14px; }
    .videoModal .form-input:focus { outline: none; border-color: #4a7c2a; }

    /* Table (Mentor-Mentee-main table style) */
    .tableWrap { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; }
    th { padding: 12px; text-align: left; font-size: 12px; font-weight: 600; color: #64748b; text-transform: uppercase; background: #f8fafc; border-bottom: 2px solid #e2e8f0; }
    td { padding: 12px; font-size: 14px; color: #1e293b; border-bottom: 1px solid #e2e8f0; }
    tr.email-row { cursor: pointer; transition: background 0.2s; }
    tr.email-row:hover { background: #f8fafc; }
    .muted { color: #9ca3af; text-align: center; padding: 40px; }

    .hidden { display: none !important; }

    /* Email modal (keep mail format, style modal to match) */
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000; padding: 1rem; }
    .modal-overlay.hidden { display: none; }
    .modal { background: #fff; border-radius: 16px; box-shadow: 0 10px 40px rgba(0,0,0,.2); max-width: 560px; width: 100%; max-height: 90vh; overflow: hidden; display: flex; flex-direction: column; }
    .modal-header { padding: 20px 24px; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; background: #f8fafc; }
    .modal-header h2 { margin: 0; font-size: 1.125rem; font-weight: 600; color: #1e293b; }
    .modal-close { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #64748b; padding: 0 0.25rem; line-height: 1; }
    .modal-close:hover { color: #1e293b; }
    .modal-body { padding: 24px; overflow-y: auto; }
    .mail-meta { border-bottom: 1px solid #e2e8f0; padding-bottom: 1rem; margin-bottom: 1rem; }
    .mail-meta-row { display: flex; margin-bottom: 0.5rem; font-size: 0.875rem; }
    .mail-meta-label { min-width: 72px; color: #64748b; }
    .mail-meta-value { color: #1e293b; word-break: break-all; }
    .mail-body { font-size: 0.9375rem; line-height: 1.6; color: #334155; white-space: pre-wrap; }
    .mail-type-badge { display: inline-block; padding: 4px 10px; border-radius: 20px; font-size: 12px; font-weight: 600; text-transform: uppercase; }
    .mail-type-general { background: #dbeafe; color: #1e40af; }
    .mail-type-partnership { background: #fce7f3; color: #be185d; }
    .mail-type-mentor_application { background: #d1fae5; color: #065f46; }

    @media (max-width: 768px) {
      .header { flex-direction: column; align-items: flex-start; }
      .statsGrid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div id="loginView" class="login-wrap">
    <div class="login-card">
      <div class="login-logo">
        <div class="login-logo-icon">C2R</div>
        <h1>Admin Login</h1>
        <p>Connect2Roots admin dashboard</p>
      </div>
      <p class="error" id="loginError"></p>
      <form class="login-form" id="loginForm">
        <div class="form-group">
          <label class="form-label" for="email">Email</label>
          <input type="email" id="email" class="form-input" placeholder="admin@connect2roots.org" />
        </div>
        <div class="form-group">
          <label class="form-label" for="password">Password</label>
          <input type="password" id="password" class="form-input" placeholder="Password" />
        </div>
        <button type="submit" class="btn-login" id="loginBtn">Sign in</button>
      </form>
    </div>
  </div>

  <div id="dashboardView" class="container hidden">
    <header class="header">
      <div class="header-left">
        <div class="header-logo">C2R</div>
        <div>
          <h1 class="title">Admin Dashboard</h1>
          <p class="subtitle">Emails, donations & resource videos</p>
        </div>
      </div>
      <div class="adminInfo">
        <div class="adminAvatar" id="adminAvatar">AD</div>
        <div>
          <p class="adminLabel">Admin</p>
          <p class="adminName" id="adminName">Admin</p>
        </div>
        <button type="button" class="logoutBtn" id="logoutBtn">Logout</button>
      </div>
    </header>

    <div class="statsGrid">
      <div class="statCard">
        <div class="statIcon blue"><i data-lucide="mail"></i></div>
        <div>
          <p class="statLabel">Total Emails</p>
          <p class="statValue" id="statEmails">0</p>
        </div>
      </div>
      <div class="statCard">
        <div class="statIcon green"><i data-lucide="heart"></i></div>
        <div>
          <p class="statLabel">Donations</p>
          <p class="statValue" id="statDonations">0</p>
        </div>
      </div>
      <div class="statCard">
        <div class="statIcon yellow"><i data-lucide="indian-rupee"></i></div>
        <div>
          <p class="statLabel">Amount</p>
          <p class="statValue" id="statAmount">₹0</p>
        </div>
      </div>
    </div>

    <div class="tabsWrap">
      <div class="tabs">
        <button type="button" class="active" data-tab="emails"><i data-lucide="inbox"></i> Emails / Inquiries</button>
        <button type="button" data-tab="donations"><i data-lucide="wallet"></i> Donations</button>
        <button type="button" data-tab="videos"><i data-lucide="video"></i> Resource Videos</button>
      </div>
      <div class="tabContent">
        <div id="emailsTab">
          <h3>Contact submissions & partnership inquiries</h3>
          <div class="tableWrap">
            <table>
              <thead><tr><th>Date</th><th>Type</th><th>Name / Company</th><th>Email</th><th>Message</th></tr></thead>
              <tbody id="emailsBody"></tbody>
            </table>
          </div>
        </div>
        <div id="donationsTab" class="hidden">
          <h3>Donations</h3>
          <div class="tableWrap">
            <table>
              <thead><tr><th>Date</th><th>Donor</th><th>Email</th><th>Amount</th><th>Status</th></tr></thead>
              <tbody id="donationsBody"></tbody>
            </table>
          </div>
        </div>
        <div id="videosTab" class="hidden">
          <h3>Resource Videos</h3>
          <p style="margin:0 0 16px 0; color:#64748b; font-size:14px;">These videos appear on the website Resources page (Videos tab). Use the YouTube video ID from the video URL (e.g. <code style="background:#f1f5f9; padding:2px 6px; border-radius:4px;">watch?v=VIDEO_ID</code>).</p>
          <div class="videosToolbar">
            <span></span>
            <button type="button" class="btnAddVideo" id="addVideoBtn"><i data-lucide="plus"></i> Add video</button>
          </div>
          <div id="videosGrid" class="videosGrid"></div>
          <div id="videosEmpty" class="muted hidden" style="padding:32px; text-align:center;">No videos yet. Add one to show on the Resources page.</div>
        </div>
      </div>
    </div>
  </div>

  <div id="emailModal" class="modal-overlay hidden" aria-hidden="true">
    <div class="modal" role="dialog" aria-labelledby="emailModalTitle">
      <div class="modal-header">
        <h2 id="emailModalTitle">Message</h2>
        <button type="button" class="modal-close" id="emailModalClose" aria-label="Close">&times;</button>
      </div>
      <div class="modal-body" id="emailModalBody"></div>
    </div>
  </div>

  <div id="videoModal" class="modal-overlay hidden" aria-hidden="true">
    <div class="modal videoModal" role="dialog" style="max-width: 480px;">
      <div class="modal-header">
        <h2 id="videoModalTitle">Add video</h2>
        <button type="button" class="modal-close" id="videoModalClose" aria-label="Close">&times;</button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="videoFormId" value="" />
        <div class="form-group">
          <label class="form-label" for="videoFormTitle">Title</label>
          <input type="text" id="videoFormTitle" class="form-input" placeholder="e.g. Career Guidance & Mentorship" />
        </div>
        <div class="form-group">
          <label class="form-label" for="videoFormDescription">Description</label>
          <input type="text" id="videoFormDescription" class="form-input" placeholder="Short description for the card" />
        </div>
        <div class="form-group">
          <label class="form-label" for="videoFormTopic">Topic</label>
          <input type="text" id="videoFormTopic" class="form-input" placeholder="e.g. Career Development" value="Career Development" />
        </div>
        <div class="form-group">
          <label class="form-label" for="videoFormVideoId">YouTube Video ID</label>
          <input type="text" id="videoFormVideoId" class="form-input" placeholder="e.g. dQw4w9WgXcQ" />
        </div>
        <div class="form-group">
          <label class="form-label" for="videoFormSortOrder">Sort order</label>
          <input type="number" id="videoFormSortOrder" class="form-input" value="0" />
        </div>
        <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:20px;">
          <button type="button" id="videoModalCancel" style="padding:10px 18px; border:1px solid #e2e8f0; border-radius:8px; background:#fff; cursor:pointer; font-weight:500;">Cancel</button>
          <button type="button" class="btnAddVideo" id="videoModalSave" style="padding:10px 18px;">Save</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    const API = window.location.origin + '/api';
    let token = localStorage.getItem('c2r_admin_token');
    let adminName = '';

    const loginView = document.getElementById('loginView');
    const dashboardView = document.getElementById('dashboardView');
    const loginError = document.getElementById('loginError');
    const emailInput = document.getElementById('email');
    const passwordInput = document.getElementById('password');
    const loginBtn = document.getElementById('loginBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const emailsBody = document.getElementById('emailsBody');
    const donationsBody = document.getElementById('donationsBody');
    const statEmails = document.getElementById('statEmails');
    const statDonations = document.getElementById('statDonations');
    const statAmount = document.getElementById('statAmount');
    let emailsList = [];

    function show(el, visible) { el.classList.toggle('hidden', !visible); }
    function authHeaders() { return { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token }; }

    function initIcons() { if (typeof lucide !== 'undefined') lucide.createIcons(); }

    document.getElementById('loginForm').addEventListener('submit', function(e) {
      e.preventDefault();
      login();
    });

    async function login() {
      const email = emailInput.value.trim();
      const password = passwordInput.value;
      loginError.textContent = '';
      loginError.classList.remove('show');
      if (!email || !password) { loginError.textContent = 'Email and password required'; loginError.classList.add('show'); return; }
      try {
        const res = await fetch(API + '/admin/login', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ email, password }) });
        const data = await res.json();
        if (!res.ok) { loginError.textContent = data.message || 'Login failed'; loginError.classList.add('show'); return; }
        token = data.token;
        adminName = (data.admin && data.admin.name) ? data.admin.name : email.split('@')[0];
        localStorage.setItem('c2r_admin_token', token);
        localStorage.setItem('c2r_admin_name', adminName);
        loginView.classList.add('hidden');
        dashboardView.classList.remove('hidden');
        document.getElementById('adminName').textContent = adminName;
        const initials = adminName.split(/\s+/).map(n => n[0]).join('').toUpperCase().slice(0, 2) || 'AD';
        document.getElementById('adminAvatar').textContent = initials;
        loadDashboard();
        initIcons();
      } catch (e) { loginError.textContent = 'Network error'; loginError.classList.add('show'); }
    }

    function logout() {
      token = null;
      localStorage.removeItem('c2r_admin_token');
      localStorage.removeItem('c2r_admin_name');
      dashboardView.classList.add('hidden');
      loginView.classList.remove('hidden');
    }

    async function loadStats() {
      try {
        const res = await fetch(API + '/admin/stats', { headers: authHeaders() });
        const data = await res.json();
        if (res.ok) {
          statEmails.textContent = data.totalEmails ?? 0;
          statDonations.textContent = data.totalDonationsCount ?? 0;
          statAmount.textContent = '₹' + (data.totalDonationsAmount || 0).toLocaleString();
        }
      } catch (e) {}
    }

    async function loadEmails() {
      try {
        const res = await fetch(API + '/admin/emails?limit=200', { headers: authHeaders() });
        const data = await res.json();
        if (!res.ok) return;
        emailsList = data.emails || [];
        if (emailsList.length === 0) {
          emailsBody.innerHTML = '<tr><td colspan="5" class="muted">No submissions yet</td></tr>';
        } else {
          emailsBody.innerHTML = emailsList.map((e, i) => {
            const nameOrCo = e.type === 'partnership' ? (e.company_name || e.contact_person || '-') : (e.name || '-');
            const msg = (e.message || '').slice(0, 80) + ((e.message || '').length > 80 ? '…' : '');
            return '<tr class="email-row" data-index="' + i + '"><td>' + new Date(e.created_at).toLocaleString() + '</td><td>' + e.type + '</td><td>' + escapeHtml(nameOrCo) + '</td><td>' + escapeHtml(e.email) + '</td><td>' + escapeHtml(msg) + '</td></tr>';
          }).join('');
          emailsBody.querySelectorAll('.email-row').forEach(row => {
            row.addEventListener('click', () => openEmailModal(emailsList[parseInt(row.dataset.index, 10)]));
          });
        }
      } catch (e) { emailsBody.innerHTML = '<tr><td colspan="5">Failed to load</td></tr>'; }
    }

    function openEmailModal(e) {
      const typeLabel = (e.type || 'general').replace(/_/g, ' ');
      const typeClass = 'mail-type-' + (e.type || 'general');
      let meta = '';
      meta += '<div class="mail-meta-row"><span class="mail-meta-label">From:</span><span class="mail-meta-value">' + escapeHtml(e.name || e.contact_person || e.company_name || '—') + ' &lt;' + escapeHtml(e.email) + '&gt;</span></div>';
      meta += '<div class="mail-meta-row"><span class="mail-meta-label">To:</span><span class="mail-meta-value">Connect2Roots</span></div>';
      meta += '<div class="mail-meta-row"><span class="mail-meta-label">Date:</span><span class="mail-meta-value">' + new Date(e.created_at).toLocaleString() + '</span></div>';
      meta += '<div class="mail-meta-row"><span class="mail-meta-label">Type:</span><span class="mail-meta-value"><span class="mail-type-badge ' + typeClass + '">' + escapeHtml(typeLabel) + '</span></span></div>';
      if (e.type === 'partnership' && (e.company_name || e.contact_person)) {
        if (e.company_name) meta += '<div class="mail-meta-row"><span class="mail-meta-label">Company:</span><span class="mail-meta-value">' + escapeHtml(e.company_name) + '</span></div>';
        if (e.contact_person) meta += '<div class="mail-meta-row"><span class="mail-meta-label">Contact:</span><span class="mail-meta-value">' + escapeHtml(e.contact_person) + '</span></div>';
      }
      if (e.type === 'mentor_application') {
        if (e.profession) meta += '<div class="mail-meta-row"><span class="mail-meta-label">Profession:</span><span class="mail-meta-value">' + escapeHtml(e.profession) + '</span></div>';
        if (e.experience) meta += '<div class="mail-meta-row"><span class="mail-meta-label">Experience:</span><span class="mail-meta-value">' + escapeHtml(e.experience) + '</span></div>';
      }
      let body = '<div class="mail-meta">' + meta + '</div>';
      body += '<div class="mail-body">' + escapeHtml(e.message || '—') + '</div>';
      if (e.type === 'mentor_application' && e.motivation) {
        body += '<div style="margin-top:1rem; padding-top:1rem; border-top:1px solid #e2e8f0;"><div class="mail-meta-label" style="margin-bottom:0.25rem;">Motivation</div><div class="mail-body">' + escapeHtml(e.motivation) + '</div></div>';
      }
      document.getElementById('emailModalTitle').textContent = typeLabel.charAt(0).toUpperCase() + typeLabel.slice(1) + ' – Message';
      document.getElementById('emailModalBody').innerHTML = body;
      document.getElementById('emailModal').classList.remove('hidden');
      document.getElementById('emailModal').setAttribute('aria-hidden', 'false');
    }

    function closeEmailModal() {
      document.activeElement && document.activeElement.blur();
      document.getElementById('emailModal').classList.add('hidden');
      document.getElementById('emailModal').setAttribute('aria-hidden', 'true');
    }

    async function loadDonations() {
      try {
        const res = await fetch(API + '/admin/donations?limit=200', { headers: authHeaders() });
        const data = await res.json();
        if (!res.ok) return;
        donationsBody.innerHTML = data.donations.length === 0
          ? '<tr><td colspan="5" class="muted">No donations yet</td></tr>'
          : data.donations.map(d => '<tr><td>' + new Date(d.created_at).toLocaleString() + '</td><td>' + escapeHtml(d.donor_name) + '</td><td>' + escapeHtml(d.donor_email) + '</td><td>₹' + (d.amount_display || 0).toLocaleString() + '</td><td>' + d.status + '</td></tr>').join('');
      } catch (e) { donationsBody.innerHTML = '<tr><td colspan="5">Failed to load</td></tr>'; }
    }

    function escapeHtml(s) { return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

    function loadDashboard() {
      loadStats();
      loadEmails();
      loadDonations();
    }

    logoutBtn.addEventListener('click', logout);
    document.getElementById('emailModalClose').addEventListener('click', closeEmailModal);
    document.getElementById('emailModal').addEventListener('click', function(ev) {
      if (ev.target === this) closeEmailModal();
    });
    document.addEventListener('keydown', function(ev) {
      if (ev.key !== 'Escape') return;
      if (!document.getElementById('emailModal').classList.contains('hidden')) closeEmailModal();
      else if (!document.getElementById('videoModal').classList.contains('hidden')) closeVideoModal();
    });
    document.querySelectorAll('.tabs button').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.tabs button').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        const tab = btn.dataset.tab;
        document.getElementById('emailsTab').classList.toggle('hidden', tab !== 'emails');
        document.getElementById('donationsTab').classList.toggle('hidden', tab !== 'donations');
        document.getElementById('videosTab').classList.toggle('hidden', tab !== 'videos');
        if (tab === 'videos') loadVideos();
        initIcons();
      });
    });

    function getYouTubeVideoId(input) {
      if (!input || typeof input !== 'string') return '';
      var s = input.trim();
      if (/^[\w-]{10,12}$/.test(s)) return s;
      try {
        var m = s.match(/(?:youtu\.be\/)([\w-]+)/);
        if (m) return m[1];
        var url = new URL(s.indexOf('http') === 0 ? s : 'https://' + s);
        if (url.hostname.replace('www.', '') === 'youtube.com') {
          var v = url.searchParams.get('v');
          if (v) return v;
          var em = url.pathname.match(/\/embed\/([\w-]+)/);
          if (em) return em[1];
        }
        if (url.hostname === 'youtu.be') return url.pathname.slice(1).split('?')[0] || '';
      } catch (e) {}
      return s;
    }
    function YOUTUBE_THUMB(videoId) {
      var id = getYouTubeVideoId(videoId);
      return id ? 'https://img.youtube.com/vi/' + encodeURIComponent(id) + '/hqdefault.jpg' : '';
    }

    async function loadVideos() {
      const grid = document.getElementById('videosGrid');
      const empty = document.getElementById('videosEmpty');
      try {
        const res = await fetch(API + '/admin/resource-videos', { headers: authHeaders() });
        if (res.status === 401) { logout(); return; }
        const list = res.ok ? await res.json() : [];
        const videos = Array.isArray(list) ? list : [];
        if (videos.length === 0) {
          grid.innerHTML = '';
          empty.classList.remove('hidden');
        } else {
          empty.classList.add('hidden');
          grid.innerHTML = videos.map(v => {
            const cleanId = getYouTubeVideoId(v.video_id);
            const thumb = v.video_id ? '<img src="' + YOUTUBE_THUMB(v.video_id) + '" alt="" onerror="this.onerror=null;this.src=\'https://img.youtube.com/vi/' + cleanId + '/mqdefault.jpg\'" />' : '<div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;color:#94a3b8;font-size:14px;">No thumbnail</div>';
            const desc = escapeHtml((v.description || '—').slice(0, 120)) + ((v.description || '').length > 120 ? '…' : '');
            return '<div class="videoCard" data-id="' + v.id + '">' +
              '<div class="videoCardThumb">' + thumb + '</div>' +
              '<div class="videoCardBody">' +
              '<p class="videoCardTitle">' + escapeHtml(v.title) + '</p>' +
              '<p class="videoCardMeta">' + escapeHtml(v.topic || '') + ' · Order: ' + (v.sort_order ?? 0) + '</p>' +
              '<p class="videoCardDesc">' + desc + '</p>' +
              '<div class="videoCardActions">' +
              '<button type="button" class="editVideo">Edit</button>' +
              '<button type="button" class="deleteVideo delete">Delete</button>' +
              '</div></div></div>';
          }).join('');
          grid.querySelectorAll('.editVideo').forEach(btn => {
            btn.addEventListener('click', () => openVideoModal(videos.find(v => v.id === parseInt(btn.closest('.videoCard').dataset.id, 10))));
          });
          grid.querySelectorAll('.deleteVideo').forEach(btn => {
            btn.addEventListener('click', () => deleteVideo(parseInt(btn.closest('.videoCard').dataset.id, 10)));
          });
        }
      } catch (e) {
        grid.innerHTML = '';
        empty.textContent = 'Failed to load videos';
        empty.classList.remove('hidden');
      }
      initIcons();
    }

    function openVideoModal(video) {
      document.getElementById('videoModalTitle').textContent = video ? 'Edit video' : 'Add video';
      document.getElementById('videoFormId').value = video ? video.id : '';
      document.getElementById('videoFormTitle').value = video ? video.title : '';
      document.getElementById('videoFormDescription').value = video ? (video.description || '') : '';
      document.getElementById('videoFormTopic').value = video ? (video.topic || 'Career Development') : 'Career Development';
      document.getElementById('videoFormVideoId').value = video ? video.video_id : '';
      document.getElementById('videoFormSortOrder').value = video ? (video.sort_order ?? 0) : document.getElementById('videosGrid').querySelectorAll('.videoCard').length;
      document.getElementById('videoModal').classList.remove('hidden');
      document.getElementById('videoModal').setAttribute('aria-hidden', 'false');
    }

    function closeVideoModal() {
      var addBtn = document.getElementById('addVideoBtn');
      if (document.activeElement && document.getElementById('videoModal').contains(document.activeElement)) {
        if (addBtn) addBtn.focus();
        else document.activeElement.blur();
      }
      document.getElementById('videoModal').classList.add('hidden');
      document.getElementById('videoModal').setAttribute('aria-hidden', 'true');
    }

    document.getElementById('addVideoBtn').addEventListener('click', () => openVideoModal(null));
    document.getElementById('videoModalClose').addEventListener('click', closeVideoModal);
    document.getElementById('videoModalCancel').addEventListener('click', closeVideoModal);
    document.getElementById('videoModal').addEventListener('click', function(ev) {
      if (ev.target === this) closeVideoModal();
    });

    async function saveVideo() {
      const id = document.getElementById('videoFormId').value;
      const title = document.getElementById('videoFormTitle').value.trim();
      const videoId = document.getElementById('videoFormVideoId').value.trim();
      if (!title || !videoId) return;
      const body = {
        title,
        description: document.getElementById('videoFormDescription').value.trim(),
        topic: document.getElementById('videoFormTopic').value.trim() || 'Career Development',
        video_id: videoId,
        sort_order: parseInt(document.getElementById('videoFormSortOrder').value, 10) || 0
      };
      try {
        const url = id ? API + '/admin/resource-videos/' + id : API + '/admin/resource-videos';
        const res = await fetch(url, {
          method: id ? 'PUT' : 'POST',
          headers: authHeaders(),
          body: JSON.stringify(body)
        });
        if (res.status === 401) { logout(); return; }
        if (res.status === 503) {
          var data = await res.json().catch(function() { return {}; });
          alert('Resource videos are not set up yet.\n\nRun in the backend folder:\nnpm run init-db\n\nThen restart the server.');
          return;
        }
        if (!res.ok) throw new Error('Save failed');
        closeVideoModal();
        loadVideos();
      } catch (e) {
        alert('Failed to save video');
      }
    }

    document.getElementById('videoModalSave').addEventListener('click', saveVideo);

    async function deleteVideo(id) {
      if (!confirm('Remove this video from the Resources page?')) return;
      try {
        const res = await fetch(API + '/admin/resource-videos/' + id, { method: 'DELETE', headers: authHeaders() });
        if (res.status === 401) { logout(); return; }
        if (!res.ok) throw new Error('Delete failed');
        loadVideos();
      } catch (e) {
        alert('Failed to delete video');
      }
    }

    if (token) {
      adminName = localStorage.getItem('c2r_admin_name') || 'Admin';
      fetch(API + '/admin/stats', { headers: authHeaders() }).then(r => {
        if (r.ok) {
          loginView.classList.add('hidden');
          dashboardView.classList.remove('hidden');
          document.getElementById('adminName').textContent = adminName;
          document.getElementById('adminAvatar').textContent = adminName.split(/\s+/).map(n => n[0]).join('').toUpperCase().slice(0, 2) || 'AD';
          loadDashboard();
          initIcons();
        } else logout();
      }).catch(() => logout());
    }
    initIcons();
  </script>
</body>
</html>
